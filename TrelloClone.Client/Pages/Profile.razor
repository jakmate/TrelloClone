@page "/profile"
@using TrelloClone.Shared.DTOs.User
@using Microsoft.AspNetCore.Authorization
@inject IAuthService AuthService
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Profile Settings</PageTitle>

<div class="p-5 m-auto profile-page">
    <div class="mb-4">
        <h1 class="fw-bold">Profile Settings</h1>
        <p class="profile-subtitle">Manage your account information</p>
    </div>

    @if (isLoading)
    {
        <LoadingSpinner></LoadingSpinner>
    }
    else if (currentUser != null)
    {
        <div class="d-flex flex-column gap-4">
            <ProfileInfoSection CurrentUser="@currentUser" OnUserUpdated="HandleUserUpdated" />

            <ChangePasswordSection></ChangePasswordSection>

            <DeleteAccountSection OnAccountDeleted="HandleAccountDeleted" />
        </div>
    }
</div>

@code {
    private UserDto? currentUser;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            currentUser = await AuthService.GetCurrentUserAsync();
            if (currentUser == null)
            {
                Navigation.NavigateTo("/login");
            }
        }
        catch
        {
            Navigation.NavigateTo("/login");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleUserUpdated(UserDto updatedUser)
    {
        currentUser = updatedUser;
    }

    private void HandleAccountDeleted()
    {
        Navigation.NavigateTo("/");
    }
}