@using TrelloClone.Shared.DTOs.User
@inject IAuthService AuthService
@inject IJSRuntime JSRuntime

<div class="profile-section p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fs-5 m-0">Change Password</h2>
    </div>

    <div class="form-group">
        <label>Current Password</label>
        <input type="password" class="form-control" @bind="changePasswordRequest.CurrentPassword" 
               placeholder="Enter current password" disabled="@isChangingPassword" />
    </div>

    <div class="form-group">
        <label>New Password</label>
        <input type="password" class="form-control" 
               value="@changePasswordRequest.NewPassword"
               @oninput="HandleNewPasswordChange"
               placeholder="Enter new password" 
               disabled="@isChangingPassword" />
        @if (!string.IsNullOrEmpty(changePasswordRequest.NewPassword))
        {
            <div class="password-requirements mt-2">
                <small class="@(MeetsLengthRequirement ? "text-success" : "text-danger")">
                    <i class="bi bi-@(MeetsLengthRequirement ? "check" : "x")-circle"></i>
                    At least 6 characters
                </small><br/>
                <small class="@(HasLetter(changePasswordRequest.NewPassword) ? "text-success" : "text-danger")">
                    <i class="bi bi-@(HasLetter(changePasswordRequest.NewPassword) ? "check" : "x")-circle"></i>
                    Contains a letter
                </small><br/>
                <small class="@(HasNumber(changePasswordRequest.NewPassword) ? "text-success" : "text-danger")">
                    <i class="bi bi-@(HasNumber(changePasswordRequest.NewPassword) ? "check" : "x")-circle"></i>
                    Contains a number
                </small>
            </div>
        }
    </div>

    <div class="form-group">
        <label>Confirm New Password</label>
        <input type="password" class="form-control @GetPasswordMatchClass()" 
               value="@confirmPassword"
               @oninput="HandleConfirmPasswordChange"
               placeholder="Confirm new password" 
               disabled="@isChangingPassword" />
        @if (!string.IsNullOrEmpty(confirmPassword))
        {
            @if (PasswordsMatch)
            {
                <small class="text-success"><i class="bi bi-check-circle"></i> Passwords match</small>
            }
            else
            {
                <small class="text-danger"><i class="bi bi-x-circle"></i> Passwords do not match</small>
            }
        }
    </div>

    <div class="form-actions">
        <button class="btn btn-primary profile-btn" @onclick="ChangePassword" 
                disabled="@(!IsFormValid || isChangingPassword)">
            @if (isChangingPassword)
            {
                <span class="spinner-border spinner-border-sm me-2"></span>
            }
            Change Password
        </button>
        <button class="btn btn-secondary profile-btn" @onclick="ResetForm" 
                disabled="@isChangingPassword">
            Cancel
        </button>
    </div>

    @if (!string.IsNullOrEmpty(changeMessage))
    {
        <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mt-3">
            @changeMessage
        </div>
    }
</div>

@code {
    private ChangePasswordRequest changePasswordRequest = new();
    private string confirmPassword = string.Empty;
    private bool isChangingPassword;
    private string changeMessage = string.Empty;
    private bool isSuccess;

    public bool MeetsLengthRequirement => changePasswordRequest.NewPassword.Length >= 6;
    public bool PasswordsMatch => changePasswordRequest.NewPassword == confirmPassword;
    public bool IsFormValid => 
        !string.IsNullOrWhiteSpace(changePasswordRequest.CurrentPassword) &&
        !string.IsNullOrWhiteSpace(changePasswordRequest.NewPassword) &&
        PasswordsMatch &&
        MeetsLengthRequirement &&
        HasLetter(changePasswordRequest.NewPassword) &&
        HasNumber(changePasswordRequest.NewPassword);

    private void HandleNewPasswordChange(ChangeEventArgs e)
    {
        changePasswordRequest.NewPassword = e.Value?.ToString() ?? string.Empty;
    }

    private void HandleConfirmPasswordChange(ChangeEventArgs e)
    {
        confirmPassword = e.Value?.ToString() ?? string.Empty;
    }

    private string GetPasswordMatchClass()
    {
        if (string.IsNullOrEmpty(confirmPassword)) return string.Empty;
        return PasswordsMatch ? "is-valid" : "is-invalid";
    }

    private bool HasLetter(string password) => password.Any(char.IsLetter);
    private bool HasNumber(string password) => password.Any(char.IsDigit);

    private async Task ChangePassword()
    {
        isChangingPassword = true;
        changeMessage = string.Empty;

        try
        {
            await AuthService.ChangePasswordAsync(changePasswordRequest);
            changeMessage = "Password changed successfully!";
            isSuccess = true;
            StateHasChanged();
            ResetForm();
        }
        catch (HttpRequestException ex)
        {
            changeMessage = ex.Message.Contains("Current password is incorrect")
                ? "Current password is incorrect"
                : ex.Message.Contains("must be at least 6 characters")
                ? "New password must be at least 6 characters and contain letters and numbers"
                : $"Error changing password: {ex.Message}";
            isSuccess = false;
        }
        catch (Exception ex)
        {
            changeMessage = $"Error changing password: {ex.Message}";
            isSuccess = false;
        }
        finally
        {
            isChangingPassword = false;
        }
    }

    private void ResetForm()
    {
        changePasswordRequest = new ChangePasswordRequest();
        confirmPassword = string.Empty;
    }
}